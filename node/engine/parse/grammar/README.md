
# Kuneiform Grammar

This directory contains the ANTLR 4 grammar files for the Kuneiform language used in Kwil DB.

## Files

- **`KuneiformLexer.g4`** - Defines tokens (keywords, operators, literals)
- **`KuneiformParser.g4`** - Defines syntax rules and language structure  
- **`generate.sh`** - Script to generate Go parser code from grammar
- **`antlr-4.13.1-complete.jar`** - ANTLR tool (auto-downloaded)

## Quick Start

### Prerequisites

- Java 17+ (required for ANTLR 4.13.1)
- Go 1.23+ (for testing generated code)

### Generating Parser

```bash
# Generate Go parser code
./generate.sh

# Verify generation worked
ls -la ../gen/
```

### Testing Changes

```bash
# Build parser package
cd ../../../..
go build ./node/engine/parse/...

# Run parser tests
go test ./node/engine/parse/... -v
```

## Development Workflow

1. **Backup** grammar files before changes
2. **Edit** `.g4` files to modify syntax
3. **Generate** parser with `./generate.sh`
4. **Update** Go visitor code in `../antlr.go` if needed
5. **Add** test cases in `../parse_test.go`
6. **Verify** all tests pass

## Grammar Overview

### Language Structure

Kuneiform supports:
- Database operations (CREATE TABLE, INSERT, SELECT, etc.)
- Action definitions with parameters and modifiers
- Namespace and role management
- Extensions and custom functions

### Recent Changes

**Optional Parameters (Phase 1)** - Added support for DEFAULT parameter syntax:

```kuneiform
CREATE ACTION my_action(
    $required_param int,
    $optional_param bool DEFAULT false,
    $nullable_param text DEFAULT null
) public {
    // action body
};
```

**Implementation:**
- Added `action_parameter` rule to support optional DEFAULT clause
- Modified `create_action_statement` to use new parameter rule
- Extended test coverage for default parameter scenarios

## Troubleshooting

### Java Version Issues

```
java.lang.UnsupportedClassVersionError: org/antlr/v4/Tool
```
**Solution:** Install Java 17+

### Generation Failures

```
antlr4: command not found
```
**Solution:** Ensure `./generate.sh` is executable and ANTLR jar is present

### Go Compilation Errors

```
missing method VisitXXX
```
**Solution:** Update visitor implementation in `../antlr.go`

## Documentation

For comprehensive grammar development guidelines, see:
- [Grammar Development Guide](../../../docs/dev/grammar-development.md)
- [Contributing Guidelines](../../../../CONTRIBUTING.md#grammar-development)

## Grammar Rules Reference

### Key Rules

- `entry` - Top-level program structure
- `statement` - Individual statements (CREATE, DROP, etc.)
- `create_action_statement` - Action definitions
- `action_parameter` - Action parameter with optional DEFAULT
- `sql_statement` - Standard SQL operations

### Token Categories

- **Keywords:** `CREATE`, `ACTION`, `DEFAULT`, `PUBLIC`, etc.
- **Operators:** `+`, `-`, `*`, `/`, `=`, `!=`, etc.  
- **Literals:** Numbers, strings, booleans, null
- **Identifiers:** Table names, column names, variables

For complete grammar details, refer to the `.g4` files in this directory.

## Railroad Diagrams
Diagrams are generated by [ebnf-convert](https://github.com/GuntherRademacher/ebnf-convert) + [rr](https://github.com/GuntherRademacher/rr).

To generate the diagrams:
- run `cat ./KuneiformParser.g4 > /tmp/grammar.g4 && sed -n -e '10,200p' ./KuneiformLexer.g4 >> /tmp/grammar.g4`, this will generate a combined `/tmp/grammar.g4` file.
- go to https://www.bottlecaps.de/ebnf-convert/, paste the content of `/tmp/grammar.g4` and click on `Convert`.
- the grammar should be converted without errors, then click on `View Diagrams`.
- from that page, you can change the grammars, colors(#3860e2), etc. and download the diagrams(HTML+SVG+embedded). Replace `rrdiagrams.html` with the downloaded file.